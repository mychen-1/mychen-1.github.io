<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>活动模块 | 陈志伟`s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1.数据结构1234567891011121314后台活动 和 本地活动同一个结构-record(activity, &#123;    type    ,id &#x3D; 0    ,start_time &#x3D; 0    ,close_time &#x3D; 0    ,status &#x3D; ?ACT_STATUS_CLOSE        % 活动开启状态    ,local_type :: local_type()">
<meta property="og:type" content="article">
<meta property="og:title" content="活动模块">
<meta property="og:url" content="http://example.com/2025/04/15/project/activity/index.html">
<meta property="og:site_name" content="陈志伟&#96;s Blog">
<meta property="og:description" content="1.数据结构1234567891011121314后台活动 和 本地活动同一个结构-record(activity, &#123;    type    ,id &#x3D; 0    ,start_time &#x3D; 0    ,close_time &#x3D; 0    ,status &#x3D; ?ACT_STATUS_CLOSE        % 活动开启状态    ,local_type :: local_type()">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/1.png">
<meta property="article:published_time" content="2025-04-15T06:16:58.000Z">
<meta property="article:modified_time" content="2025-04-15T07:51:05.487Z">
<meta property="article:author" content="陈志伟">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/1.png">
  
    <link rel="alternate" href="/atom.xml" title="陈志伟`s Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">陈志伟`s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">one</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-project/activity" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/15/project/activity/" class="article-date">
  <time class="dt-published" datetime="2025-04-15T06:16:58.000Z" itemprop="datePublished">2025-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      活动模块
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-数据结构"><a href="#1-数据结构" class="headerlink" title="1.数据结构"></a>1.数据结构</h1><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">后台活动 和 本地活动同一个结构</span><br><span class="line"><span class="keyword">-record</span><span class="params">(activity, &#123;</span></span><br><span class="line"><span class="params">    type</span></span><br><span class="line"><span class="params">    ,id = <span class="number">0</span></span></span><br><span class="line"><span class="params">    ,start_time = <span class="number">0</span></span></span><br><span class="line"><span class="params">    ,close_time = <span class="number">0</span></span></span><br><span class="line"><span class="params">    ,status = ?ACT_STATUS_CLOSE        <span class="comment">% 活动开启状态</span></span></span><br><span class="line"><span class="params">    ,local_type :: local_type()</span></span><br><span class="line"><span class="params">    ,cross_type :: cross_group_type()       <span class="comment">% 跨服类型</span></span></span><br><span class="line"><span class="params">    ,group_info                             <span class="comment">% 跨服信息</span></span></span><br><span class="line"><span class="params">    ,times = <span class="number">0</span>                              <span class="comment">% 表示循环的活动已经执行了 第几次了  从 0 开始</span></span></span><br><span class="line"><span class="params">    ,round = <span class="number">0</span>                              <span class="comment">% 有些循环的奖励，表示当前是 第一个循环</span></span></span><br><span class="line"><span class="params">    ...</span></span><br><span class="line"><span class="params">&#125;)</span>.</span><br></pre></td></tr></table></figure>

<h2 id="1-reload-activity-加载活动接口"><a href="#1-reload-activity-加载活动接口" class="headerlink" title="1.reload_activity 加载活动接口"></a>1.reload_activity 加载活动接口</h2><p>流程如下：</p>
<p><img src="/../../images/1.png" alt="1"></p>
<p>1.此接口复用高，  进程init使用、跨服组变化、0点事件、等。</p>
<h1 id="1-init"><a href="#1-init" class="headerlink" title="1.init"></a>1.init</h1><p>1.监听事件， 0点、配置加载、节点连接、组信息变化。</p>
<p>2.init所有活动。</p>
<ol>
<li>先删除本地所有后台活动，再从数据库查询所有后台活动。（实现更新）</li>
<li>开启所有状态为开启的活动。 根据当前时间设置状态和定时器（只设置当日的， 因为有0点事件）</li>
<li>reload_activity</li>
</ol>
<p>3.对于跨服活动。1.游戏服是主服，下发到子服。 2.游戏服是子服请求</p>
<p>​	注意：开服的时候，所有游戏服是无规则开启的。 在第三步同步的时候，很可能其他服未开启，导致同步失败。  </p>
<p>​	解决办法：第一步中 有监听事件节点连接。   节点连接的时候，会去分发或者请求的。</p>
<h2 id="2-group-update-组变化"><a href="#2-group-update-组变化" class="headerlink" title="2. group_update 组变化"></a>2. group_update 组变化</h2><p>这个是事件，携带变化的组信息。 重新加载一下活动。 主要是加载未开启，因为已开启的活动数据不会再改变。</p>
<p>未开启活动，检测所有条件，然后检测当前状态，就抛出开启事件。</p>
<p>疑问：对于一个跨服活动，最开始未开启设置开启定时器，然后跨服信息未满足，导致未开启。然后组信息变化。这样活动开启是不是直接跳到活动某个阶段（活动开启也分多种  预备期 展示期）。  这样正常嘛？</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>1.对于活动来说， 着重点主要是活动开启，状态变化， 0点，和 跨服组变化。</p>
<p>2.注意点是 关服开服时间长， 对于开服时 对于旧活动处理。，</p>
<p>3.单个活动 数据的安全性， 对于跨服活动， 跨服组信息变化。 跨周活动。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/04/15/project/activity/" data-id="cm9ibshsn000024uyel403aa6" data-title="活动模块" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/04/15/project/merge/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          合服
        
      </div>
    </a>
  
  
    <a href="/2025/04/15/project/title/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">跨服分组</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">四月 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/04/17/project/notes/">erlang杂记</a>
          </li>
        
          <li>
            <a href="/2025/04/15/project/cache/">缓存模块</a>
          </li>
        
          <li>
            <a href="/2025/04/15/project/summarize/">跨服 活动 合服总结</a>
          </li>
        
          <li>
            <a href="/2025/04/15/project/merge/">合服</a>
          </li>
        
          <li>
            <a href="/2025/04/15/project/activity/">活动模块</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 陈志伟<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>